"use strict";Object.defineProperty(exports, "__esModule", {value: true});var _rxjs = require('rxjs');var u=class{constructor(){this.subjects={}}listen(e,t){return this.subjects[e]||(this.subjects[e]=new _rxjs.Subject),this.subjects[e].subscribe(t)}emit(e,t){this.subjects[e]||(this.subjects[e]=new _rxjs.Subject),this.subjects[e].next(t)}dispose(){for(let e in this.subjects)this.subjects[e].complete();this.subjects={}}};var m={broadcast:!1},S= exports.defaultCacheClearOptions ={broadcast:!1},l= exports.CacheItem =class{constructor({data:e,expiresAt:t=null}){this.data=e,this.expiresAt=t}isResolving(){return this.data instanceof Promise}hasExpired(){return this.expiresAt===null||this.expiresAt<new Date}expiresIn(e){return this.expiresAt=new Date,this.expiresAt.setMilliseconds(this.expiresAt.getMilliseconds()+e),this}},h= exports.DefaultCache =class{constructor(){this.elements=new Map;this.event=new u}resolve(e,t){Promise.resolve(t.data).then(i=>{if(i==null)return this.remove(e);t.data=i,this.broadcast(e,i)})}get(e){return this.elements.get(e)}set(e,t){this.elements.set(e,t),this.resolve(e,t)}remove(e,t){let{broadcast:i}={...m,...t};i&&this.broadcast(e,void 0),this.elements.delete(e)}clear(e){let{broadcast:t}={...S,...e};if(t)for(let i of this.elements.keys())this.broadcast(i,void 0);this.elements.clear()}has(e){return this.elements.has(e)}subscribe(e,t){return this.event.listen(e,t)}broadcast(e,t){this.event.emit(e,t)}};var F=d=>fetch(d).then(e=>{if(!e.ok)throw Error("Not a 2XX response.");return e.json()}),p= exports.defaultOptions ={cache:new h,errors:new u,fetcher:F,initialData:void 0,loadInitialCache:!0,revalidateOnStart:!0,dedupingInterval:2e3,revalidateOnFocus:!0,focusThrottleInterval:5e3,revalidateOnReconnect:!0},f= exports.defaultRevalidateOptions ={...p,force:!1},D= exports.defaultMutateOptions ={revalidate:!0,revalidateOptions:{...f}},R= exports.defaultClearOptions ={broadcast:!1};var W=class{constructor(e){this.options={...p,...e}}get cache(){return this.options.cache}get errors(){return this.options.errors}requestData(e,t){return t(e).catch(i=>{this.errors.emit(e,i);return})}resolveKey(e){if(typeof e=="function")try{return e()}catch (e2){return}return e}clear(e,t){let i={...R,...t};if(e==null)return this.cache.clear(i);if(!Array.isArray(e))return this.cache.remove(e,i);for(let r of e)this.cache.remove(r,i)}revalidate(e,t){if(!e)return;let{fetcher:i,dedupingInterval:r}=this.options,{force:s,fetcher:n,dedupingInterval:o}={...f,fetcher:i,dedupingInterval:r,...t},a;(s||!this.cache.has(e)||this.cache.has(e)&&this.cache.get(e).hasExpired())&&(a=this.requestData(e,n)),a!==void 0&&this.mutate(e,new l({data:a}).expiresIn(o),{revalidate:!1})}mutate(e,t,i){if(!e)return;let{revalidate:r,revalidateOptions:s}={...D,...i},n;if(typeof t=="function"){let o=null;if(this.cache.has(e)){let a=this.cache.get(e);a.isResolving()||(o=a.data)}n=t(o)}else n=t;this.cache.set(e,n instanceof l?n:new l({data:n})),r&&this.revalidate(e,s)}subscribe(e,t){if(e){let i=this.cache.subscribe(e,t);return()=>i.unsubscribe()}return()=>{}}subscribeErrors(e,t){if(e){let i=this.errors.listen(e,t);return()=>i.unsubscribe()}return()=>{}}subscribeVisibility(e,{throttleInterval:t=5e3,enabled:i=!0}={}){if(i&&typeof window!="undefined"){let r=null,s=()=>{let n=Date.now();(r===null||n-r>t)&&(r=n,e())};return window.addEventListener("focus",s),()=>window.removeEventListener("focus",s)}return()=>{}}subscribeNetwork(e,{enabled:t=!0}={}){return t&&typeof window!="undefined"?(window.addEventListener("online",e),()=>window.removeEventListener("online",e)):()=>{}}get(e){if(e&&this.cache.has(e)){let t=this.cache.get(e);if(!t.isResolving())return t.data}return}getOrWait(e){return new Promise(t=>{let i=this.get(e);if(i)return t(i);let r=this.subscribe(e,s=>(r(),t(s)))})}use(e,t,i,r){let{fetcher:s,initialData:n,loadInitialCache:o,revalidateOnStart:a,dedupingInterval:O,revalidateOnFocus:C,focusThrottleInterval:y,revalidateOnReconnect:x}={...this.options,...r},K=(c,j)=>this.mutate(this.resolveKey(e),c,j),w=c=>this.revalidate(this.resolveKey(e),c),v=()=>w({fetcher:s,dedupingInterval:O});a&&v();let g=this.subscribe(this.resolveKey(e),t),I=this.subscribeErrors(this.resolveKey(e),i),E=this.subscribeVisibility(v,{throttleInterval:y,enabled:C}),P=this.subscribeNetwork(v,{enabled:x}),M=()=>{g(),I(),E(),P()};if(n&&K(n,{revalidate:!1}),o){let c=this.get(this.resolveKey(e));c&&t(c)}return{unsubscribe:M}}};exports.CacheItem = l; exports.DefaultCache = h; exports.EventEmitter = u; exports.SWR = W; exports.defaultCacheClearOptions = S; exports.defaultCacheRemoveOptions = m; exports.defaultClearOptions = R; exports.defaultMutateOptions = D; exports.defaultOptions = p; exports.defaultRevalidateOptions = f;
/*! Copyright (c) Èrik C. Forés - MIT */
